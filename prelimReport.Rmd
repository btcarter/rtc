---
title: "Readiness to Change"
author: "Benjamin Carter"
date: "6/20/2020"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 3
    toc_float: yes
  ioslides_presentation:
    incremental: yes
    widescreen: true
  slidy_presentation:
    incremental: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(dplyr)
library(gmodels)
# paths V:\Depts\CtrTransRsch\Dept Private\CTR Staff\PROJECT - Readiness to change manuscript\DATA
data.dir.path <- file.path(
  "V:",
  "Depts", 
  "CtrTransRsch", 
  "Dept Private", 
  "CTR Staff", 
  "PROJECT - Readiness to change manuscript", 
  "DATA"
  )
```

```{r loadData, include=FALSE}
df <- readxl::read_xlsx(
  file.path(data.dir.path, "Nick_Rural16_OAT 6-11-20.xlsx")
  )

```


```{r selection, include=FALSE}
df.processed <- df %>% 
  mutate(
    Gender = ifelse(
      Gender == 1,
      "Female",
      "Male"
      ),
    rtc_diet = ifelse(
      `1a_pre` == 1,
      "precontemplative",
      ifelse(
        `1a_pre` == 2,
        "contemplative",
        ifelse(
          `1a_pre` == 3,
          "preparation",
          ifelse(
            `1a_pre` == 4,
            "action",
            ifelse(
              `1a_pre` == 5,
              "maintain",
              `1a_pre`
            )
          )
        )
      )
    ),
    rtc_exercise = ifelse(
      `2a_pre` == 1,
      "precontemplative",
      ifelse(
        `2a_pre` == 2,
        "contemplative",
        ifelse(
          `2a_pre` == 3,
          "preparation",
          ifelse(
            `2a_pre` == 4,
            "action",
            ifelse(
              `2a_pre` == 5,
              "maintain",
              `2a_pre`
            )
          )
        )
      )
    ),
    rtc_diet_groups = ifelse(
      `1a_pre` == 1,
      "Pre/Contemplative",
      ifelse(
        `1a_pre` == 2,
        "Pre/Contemplative",
        ifelse(
          `1a_pre` == 3,
          "Preparation",
          ifelse(
            `1a_pre` == 4,
            "Action",
            ifelse(
              `1a_pre` == 5,
              "Maintain",
              `1a_pre`
            )
          )
        )
      )
    ),
    rtc_exercise_groups = ifelse(
    `2a_pre` == 1,
    "Pre/Contemplative",
    ifelse(
      `2a_pre` == 2,
      "Pre/Contemplative",
      ifelse(
        `2a_pre` == 3,
        "Preparation",
        ifelse(
          `2a_pre` == 4,
          "Action",
          ifelse(
            `2a_pre` == 5,
            "Maintain",
            `2a_pre`
          )
        )
      )
    )
  ),
  Include = ifelse(
    is.na(`1a_pre`) |
      is.na(`2a_pre`),
    "FALSE",
    "TRUE"
  ),
  MaxWeightLost = MaxWeightLost*-1
) %>% 
  select(
    rtc_diet,
    rtc_diet_groups,
    rtc_exercise,
    rtc_exercise_groups,
    Include,
    Gender,
    Age,
    `Start weight` = Todays_Weight,
    BMI,
    `Maximum weight lost` = MaxWeightLost,
    `Percent weight lost` = pWeightLost,
    `Lost 7 percent during core` = Met7GoalCore,
    `Lost 7 percent overall` = Met7GoalOVL,
    `Lost 5 percent during core` = Met5GoalCore,
    `Lost 5 percent overall` = Met5GoalOVL,
    `Core attendance` = Core,
    `Post-core attendance` = AfterCore,
    `Overall attendance` = `Number of Sessions`,
    `Met fat goal` = FatGramGoalMet,
    `Met fat goal (percentage of sessions)` = Met_Fat_Gram,
    `Met exercise goal at least 50 percent` = Exercise_Goal_50_Met,
    `Met exercise goal (percentage of sessions)` = Met_Activity_Goal
  ) %>% 
  mutate(
    rtc_diet_groups = as.factor(
      rtc_diet_groups
      ),
    rtc_exercise_groups = as.factor(
      rtc_exercise_groups
      ),
    `Lost 7 percent during core` = ifelse(
      `Lost 7 percent during core` == 1,
      TRUE,
      FALSE
      ),
    `Lost 7 percent overall` = ifelse(
      `Lost 7 percent overall` == 1,
      TRUE,
      FALSE
      ),
    `Lost 5 percent during core` = ifelse(
      `Lost 5 percent during core` == 1,
      TRUE,
      FALSE
    ),
    `Lost 5 percent overall` = ifelse(
      `Lost 5 percent overall` == 1,
      TRUE,
      FALSE
    ),
    `Met fat goal` = ifelse(
      `Met fat goal` == 1,
      TRUE,
      FALSE
    ),
    `Met exercise goal at least 50 percent` = ifelse(
      `Met exercise goal at least 50 percent` == 1,
      TRUE,
      FALSE
    )
  )

df.processed$rtc_diet_groups <- factor(
  df.processed$rtc_diet_groups,
  levels = c("Pre/Contemplative", "Preparation", "Action", "Maintain")
  )

df.processed$rtc_exercise_groups <- factor(
  df.processed$rtc_exercise_groups,
  levels = c("Pre/Contemplative", "Preparation", "Action", "Maintain")
  )

```


# Descriptives

## Comparison between included/excluded individuals

```{r message=FALSE, warning=FALSE}
tab1 <- compareGroups::compareGroups(
  Include ~ .- rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet,
  df.processed
  )

compareGroups::createTable(
  tab1,
  show.p.overall = FALSE
  ) %>% 
  compareGroups::export2md()

```

## Summary statistics of included participants

```{r}
df.processed <- df.processed %>% 
  filter(
    Include == "TRUE"
  )

tab1 <- compareGroups::compareGroups(
   ~ . - Include - rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet,
  df.processed
  )

compareGroups::createTable(
  tab1,
  show.n = FALSE
  ) %>% 
  compareGroups::export2md()
```


# Comparison of categorical variables by readiness to change

## Readiness to change diet

```{r categoricals, message=FALSE,warning=FALSE,echo=FALSE}

binary_vars <- list(
  "Lost 7 percent during core" = "Lost 7 percent during core",
  "Lost 7 percent overall" = "Lost 7 percent overall",
  "Lost 5 percent during core" = "Lost 5 percent during core",
  "Lost 5 percent overall" = "Lost 5 percent overall",
  "Met fat goal" = "Met fat goal",
  "Met exercise goal at least 50 percent" = "Met exercise goal at least 50 percent"
  )

chi_diet <- function(x){
  chisq <- chisq.test(
    df.processed$rtc_diet_groups,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.diet <- lapply(binary_vars, chi_diet)

for (i in names(chis.diet)){
  print(i)
  print(chis.diet[[i]])
}

```

## Readiness to change exercise

```{r}

chi_exercise <- function(x){
  chisq <- chisq.test(
    df.processed$rtc_exercise_groups,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.exercise <- lapply(binary_vars, chi_exercise)

for (i in names(chis.exercise)){
  print(i)
  print(chis.exercise[[i]])
}

```

# Comparison of continuous variables by readiness to change

## Readiness to change diet

```{r continuous}

cont_vars <- list(
  "Core attendance" = "Core attendance",
  "Post-core attendance" = "Post-core attendance",
  "Overall attendance" = "Overall attendance",
  "Maximum weight lost" = "Maximum weight lost",
  "Percent weight lost" = "Percent weight lost",
  "Met fat goal (percentage of sessions)" = 
    "Met fat goal (percentage of sessions)",
  "Met exercise goal (percentage of sessions)" = 
    "Met exercise goal (percentage of sessions)"
)

aov_readiness <- function(x, y){
  aov.results <- aov(
    df.processed[[x]] ~ df.processed[[y]],
    data = df.processed
      )
  
  return(aov.results)
}

aov_diet <- lapply(cont_vars, aov_readiness, y = "rtc_diet_groups")

lapply(aov_diet, summary)

```

## Readiness to change exercise

```{r continuous2}

aov_exercise <- lapply(cont_vars, aov_readiness, y = "rtc_exercise_groups")

lapply(aov_exercise, summary)

```

## Interactions in readiness to change

```{r interactions}

cross.both <- chisq.test(
  df.processed$rtc_diet_groups,
  df.processed$rtc_exercise_groups,
  correct = TRUE
  )

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  return(as.numeric(CV))
}

CV <- cv.test(
  df.processed$rtc_diet_groups,
  df.processed$rtc_exercise_groups
  )

# fmla <-  as.formula("df.processed$`Maximum weight lost` ~ df.processed$rtc_diet_groups*df.processed$rtc_exercise_groups, df.processed")
```

Responses to the readiness to change questions are probably related correlated. This would make sense as individuals who are willing to change their diet are probably more likely to change their exercise as well. The converse is probably also true. Cramer's V between both questions is `r CV`. This interaction is incorporated into the predictive models.

```{r}
knitr::kable(as.data.frame(cross.both$observed) %>% tidyr::spread(key = Var2, value = Freq))
```

# Predictive models

Statistical models were created in an attempt to predict outcomes based on patient demographics and baseline response to the readiness to change survey questions. The following terms were entered into the model: starting weight, age, gender, BMI, readiness to change diet, readiness to change exercise. No interactions were included in either model. A logistic model was used to predict binary outcomes (e.g. did they lose 7% body weight by the end of the study). A linear model was used to predict countinuous outcomes (e.g. what percentage of their body weight were they able to lose).

## Logistic models for categorical outcomes

```{r}

model_log <- function(x){

  model <- glm(
    formula = 
      df.processed[[x]] ~ 
      rtc_diet_groups * 
      rtc_exercise_groups + 
      Age +
      Gender +
      BMI +
      `Start weight`, 
    data = df.processed, 
    family = binomial
    ) %>% 
    summary()
  
  return(
    as.data.frame(
      model$coefficients
      )
    )
}

binary_list <- lapply(binary_vars, model_log)

binary_list

```

## Linear model for continuous outcomes

```{r}

model_lm <- function(x){
  
  model <- lm(
    formula = 
      df.processed[[x]] ~ 
      rtc_diet_groups * 
      rtc_exercise_groups + 
      Age +
      Gender +
      BMI +
      `Start weight`, 
    data = df.processed
    ) %>% 
    summary()
  
  a <- data.frame(
        "Beta estimate" = model$coefficients[,1],
        "p-value" = model$coefficients[,4]
        )
  
  return(a)
}

continuous_list <- lapply(cont_vars, model_lm)

continuous_list

```



