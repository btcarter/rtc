---
title: "Readiness to Change"
author: "Benjamin Carter"
date: "6/20/2020"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
  slidy_presentation:
    incremental: yes
  ioslides_presentation:
    incremental: yes
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(dplyr)
library(tidyr)
library(gmodels)
library(ggplot2)
# paths V:\Depts\CtrTransRsch\Dept Private\CTR Staff\PROJECT - Readiness to change manuscript\DATA
data.dir.path <- file.path(
  "V:",
  "Depts", 
  "CtrTransRsch", 
  "Dept Private", 
  "CTR Staff", 
  "PROJECT - Readiness to change manuscript", 
  "DATA"
  )
```

```{r loadData, include=FALSE}
df <- readxl::read_xlsx(
  file.path(data.dir.path, "Nick_Rural16_OAT 6-11-20.xlsx")
  )

```


```{r selection, include=FALSE}
df.processed <- df %>% 
  mutate(
    Gender = ifelse(
      Gender == 1,
      "Female",
      "Male"
      ),
    rtc_diet = ifelse(
      `1a_pre` == 1,
      "precontemplative",
      ifelse(
        `1a_pre` == 2,
        "contemplative",
        ifelse(
          `1a_pre` == 3,
          "preparation",
          ifelse(
            `1a_pre` == 4,
            "action",
            ifelse(
              `1a_pre` == 5,
              "maintain",
              `1a_pre`
            )
          )
        )
      )
    ),
    rtc_exercise = ifelse(
      `2a_pre` == 1,
      "precontemplative",
      ifelse(
        `2a_pre` == 2,
        "contemplative",
        ifelse(
          `2a_pre` == 3,
          "preparation",
          ifelse(
            `2a_pre` == 4,
            "action",
            ifelse(
              `2a_pre` == 5,
              "maintain",
              `2a_pre`
            )
          )
        )
      )
    ),
    rtc_diet_groups = ifelse(
      `1a_pre` == 1,
      "Pre/Contemplative",
      ifelse(
        `1a_pre` == 2,
        "Pre/Contemplative",
        ifelse(
          `1a_pre` == 3,
          "Preparation",
          ifelse(
            `1a_pre` == 4,
            "Action",
            ifelse(
              `1a_pre` == 5,
              "Maintain",
              `1a_pre`
            )
          )
        )
      )
    ),
    rtc_exercise_groups = ifelse(
    `2a_pre` == 1,
    "Pre/Contemplative",
    ifelse(
      `2a_pre` == 2,
      "Pre/Contemplative",
      ifelse(
        `2a_pre` == 3,
        "Preparation",
        ifelse(
          `2a_pre` == 4,
          "Action",
          ifelse(
            `2a_pre` == 5,
            "Maintain",
            `2a_pre`
          )
        )
      )
    )
  ),
  Include = ifelse(
    is.na(`1a_pre`) |
      is.na(`2a_pre`),
    "FALSE",
    "TRUE"
  ),
  MaxWeightLost = MaxWeightLost*-1
) %>% 
  select(
    rtc_diet,
    rtc_diet_groups,
    rtc_exercise,
    rtc_exercise_groups,
    Include,
    Gender,
    Age,
    `Start weight` = Todays_Weight,
    BMI,
    `Maximum weight lost` = MaxWeightLost,
    `Percent weight lost` = pWeightLost,
    `Lost 7 percent during core` = Met7GoalCore,
    `Lost 7 percent overall` = Met7GoalOVL,
    `Lost 5 percent during core` = Met5GoalCore,
    `Lost 5 percent overall` = Met5GoalOVL,
    `Core attendance` = Core,
    `Post-core attendance` = AfterCore,
    `Overall attendance` = `Number of Sessions`,
    `Met fat goal` = FatGramGoalMet,
    `Met fat goal (percentage of sessions)` = Met_Fat_Gram,
    `Met exercise goal at least 50 percent` = Exercise_Goal_50_Met,
    `Met exercise goal (percentage of sessions)` = Met_Activity_Goal
  ) %>% 
  mutate(
    rtc_diet_groups = as.factor(
      rtc_diet_groups
      ),
    rtc_exercise_groups = as.factor(
      rtc_exercise_groups
      ),
    `Lost 7 percent during core` = ifelse(
      `Lost 7 percent during core` == 1,
      TRUE,
      FALSE
      ),
    `Lost 7 percent overall` = ifelse(
      `Lost 7 percent overall` == 1,
      TRUE,
      FALSE
      ),
    `Lost 5 percent during core` = ifelse(
      `Lost 5 percent during core` == 1,
      TRUE,
      FALSE
    ),
    `Lost 5 percent overall` = ifelse(
      `Lost 5 percent overall` == 1,
      TRUE,
      FALSE
    ),
    `Met fat goal` = ifelse(
      `Met fat goal` == 1,
      TRUE,
      FALSE
    ),
    `Met exercise goal at least 50 percent` = ifelse(
      `Met exercise goal at least 50 percent` == 1,
      TRUE,
      FALSE
    )
  )

df.processed$rtc_diet_groups <- factor(
  df.processed$rtc_diet_groups,
  levels = c("Pre/Contemplative", "Preparation", "Action", "Maintain")
  )

df.processed$rtc_exercise_groups <- factor(
  df.processed$rtc_exercise_groups,
  levels = c("Pre/Contemplative", "Preparation", "Action", "Maintain")
  )

```

# Primary Analysis
## Descriptives

### Included vs Excluded 

```{r message=FALSE, warning=FALSE}
tab1 <- compareGroups::compareGroups(
  Include ~ .- rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet,
  df.processed
  )

compareGroups::createTable(
  tab1,
  show.p.overall = FALSE
  ) %>% 
  compareGroups::export2md()

```

### Included only

```{r}
df.processed <- df.processed %>% 
  filter(
    Include == "TRUE"
  )

tab1 <- compareGroups::compareGroups(
   ~ . - Include - rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet,
  df.processed
  )

compareGroups::createTable(
  tab1,
  show.n = FALSE
  ) %>% 
  compareGroups::export2md()
```


## Categorical Variables

Categorical variables (i.e. variables that were nominal rather than quantitative in nature) were examined in relation to readiness to change diet or exercise using a Pearson's chi-square analysis. What follows are the reported $\chi^2$ statistics, degrees of freedom, and p-values from each test.

### Diet

```{r categoricals, message=FALSE,warning=FALSE,echo=FALSE}

binary_vars <- list(
  "Lost 7 percent during core" = "Lost 7 percent during core",
  "Lost 7 percent overall" = "Lost 7 percent overall",
  "Lost 5 percent during core" = "Lost 5 percent during core",
  "Lost 5 percent overall" = "Lost 5 percent overall",
  "Met fat goal" = "Met fat goal",
  "Met exercise goal at least 50 percent" = "Met exercise goal at least 50 percent"
  )

chi_diet <- function(x){
  chisq <- chisq.test(
    df.processed$rtc_diet_groups,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.diet <- lapply(binary_vars, chi_diet)

df.stats <- data.frame(
  "Variable"=character(),
  "X-squared"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(chis.diet)){
  row.to.add <- data.frame(
    "Variable" = i,
    "X-squared" = chis.diet[[i]]$statistic,
    "df" = chis.diet[[i]]$parameter,
    "p-value" = chis.diet[[i]]$p.value,
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_diet_groups,
      fill = Val
    )
  ) +
  geom_bar(
    position = "fill"
  ) + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Diet",
    y = "Proportion of Group",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_diet_groups,
      fill = Val
    )
  ) +
  geom_bar() + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Diet",
    y = "Count",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

```

#### Distribution Tables

```{r}
knitr::kable(
  chis.diet$`Lost 7 percent during core`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 7 percent during core" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.diet$`Lost 7 percent overall`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 7 percent overall" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.diet$`Lost 5 percent during core`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 5 percent during core" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.diet$`Lost 5 percent overall`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 5 percent overall" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.diet$`Met fat goal`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Met fat goal" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.diet$`Met exercise goal at least 50 percent`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Met exercise goal at least 50 percent" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )



```


### Exercise

```{r}

chi_exercise <- function(x){
  chisq <- chisq.test(
    df.processed$rtc_exercise_groups,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.exercise <- lapply(binary_vars, chi_exercise)

df.stats <- data.frame(
  "Variable"=character(),
  "X-squared"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(chis.exercise)){
  row.to.add <- data.frame(
    "Variable" = i,
    "X-squared" = chis.exercise[[i]]$statistic,
    "df" = chis.exercise[[i]]$parameter,
    "p-value" = chis.exercise[[i]]$p.value,
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_exercise_groups,
      fill = Val
    )
  ) +
  geom_bar(
    position = "fill"
  ) + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Exercise",
    y = "Proportion of Group",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_exercise_groups,
      fill = Val
    )
  ) +
  geom_bar() + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Exercise",
    y = "Count",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

```

#### Distribution Tables

```{r}

knitr::kable(
  chis.exercise$`Lost 7 percent during core`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 7 percent during core" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.exercise$`Lost 7 percent overall`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 7 percent overall" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.exercise$`Lost 5 percent during core`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 5 percent during core" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.exercise$`Lost 5 percent overall`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Lost 5 percent overall" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.exercise$`Met fat goal`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Met fat goal" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

knitr::kable(
  chis.exercise$`Met exercise goal at least 50 percent`$observed
) %>% 
  kableExtra::add_header_above(c(" " = 1,"Met exercise goal at least 50 percent" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 4) %>%
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )


```


## Continuous Variables

The effect of readiness to change on quantitative measures were examined using via an analysis of variance. The appropriate statistics from each test are found below.

### Diet

```{r continuous, message=FALSE}

cont_vars <- list(
  "Core attendance" = 
    "Core attendance",
  "Post-core attendance" = 
    "Post-core attendance",
  "Overall attendance" = 
    "Overall attendance",
  "Maximum weight lost" = 
    "Maximum weight lost",
  "Percent weight lost" = 
    "Percent weight lost",
  "Met fat goal (percentage of sessions)" = 
    "Met fat goal (percentage of sessions)",
  "Met exercise goal (percentage of sessions)" = 
    "Met exercise goal (percentage of sessions)"
)

aov_readiness <- function(x, y){
  aov.results <- aov(
    df.processed[[x]] ~ df.processed[[y]],
    data = df.processed
      )
  
  return(aov.results)
}

aov_diet <- lapply(cont_vars, aov_readiness, y = "rtc_diet_groups")

#lapply(aov_diet, summary)

df.stats <- data.frame(
  "Variable"=character(),
  "F-statistic"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(aov_diet)){
  a <- summary(aov_diet[[i]])
  row.to.add <- data.frame(
    "Variable" = i,
    "F-statistic" = a[[1]]$`F value`[1],
    "df" = a[[1]]$`Df`[1],
    "p-value" = a[[1]]$`Pr(>F)`[1],
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(names(cont_vars))
  ) %>% 
  ggplot(
    aes(
      rtc_diet_groups,
      Val
    )
  ) +
  geom_boxplot() +
  facet_wrap(Outcome~., ncol = 4, scales = "free") +
  theme_classic() +
  labs(
    title = "Who Met Their Goal?",
    x = "Readiness to Change Diet",
    y = "Measure"
  ) +
  theme(
    axis.text.x = element_text(angle = 90)
  )

```

### Exercise

```{r continuous2}

aov_exercise <- lapply(cont_vars, aov_readiness, y = "rtc_exercise_groups")

# lapply(aov_exercise, summary)

df.stats <- data.frame(
  "Variable"=character(),
  "F-statistic"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(aov_exercise)){
  a <- summary(aov_exercise[[i]])
  row.to.add <- data.frame(
    "Variable" = i,
    "F-statistic" = a[[1]]$`F value`[1],
    "df" = a[[1]]$`Df`[1],
    "p-value" = a[[1]]$`Pr(>F)`[1],
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(names(cont_vars))
  ) %>% 
  ggplot(
    aes(
      rtc_exercise_groups,
      Val
    )
  ) +
  geom_boxplot() +
  facet_wrap(Outcome~., ncol = 4, scales = "free") +
  theme_classic() +
  labs(
    title = "Who Met Their Goal?",
    x = "Readiness to Change Exercise",
    y = "Measure"
  ) +
  theme(
    axis.text.x = element_text(angle = 90)
  )

```

## Potential interaction in RTC

```{r interactions}

cross.both <- chisq.test(
  df.processed$rtc_diet_groups,
  df.processed$rtc_exercise_groups,
  correct = TRUE
  )

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  return(as.numeric(CV))
}

CV <- cv.test(
  df.processed$rtc_diet_groups,
  df.processed$rtc_exercise_groups
  )

```

Responses to the readiness to change questions are probably related correlated. This would make sense as individuals who are willing to change their diet are probably more likely to change their exercise as well. The converse is probably also true. Cramer's V between both questions is `r CV`. This indicates there is a relatively large association between readiness to change diet and readiness to change exercise. This association can be treated in one of two ways: it can be used to simplify the predictive model (i.e. because the responses to the questions are correlated we need only consider the responses to one of the questions and can ignore the other) or this can be included as an interaction in a multivariate model.

```{r, fig.height=7}

coi <- as.data.frame(
  cross.both$observed
  ) %>% 
  tidyr::spread(
    key = df.processed.rtc_diet_groups, 
    value = Freq
    ) %>% 
  rename(
    "Readiness to Change Exercise" = Var2
  )

knitr::kable(coi) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(
    c(" ", "Readiness to Change Diet" = 4)
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(names(binary_vars))
  ) %>% 
  ggplot(
    aes(
      Outcome,
      fill = Val
    )
  ) +
  geom_bar(
    position = "fill"
  ) +
  facet_grid(
    rtc_exercise_groups ~ rtc_diet_groups,
    labeller = label_both
  ) +
  theme_classic() +
  labs(
    title = "Readiness to Change Success",
    x = "Goal",
    y = "Proportion",
    fill = "Met Goal"
  )  +
  theme(
    axis.text.x = element_text(angle = 90),
    strip.text = element_text(size = 5)
  )

```

## Predictive models for success

Now we can revisit the models from the first analysis. Given the potential interaction in readiness to change survey responses, there are essentially two different forms our model can take: (1) a model with a single term representing the response to only one of the readiness to change questions, (2) a model with two terms using both readiness to change questions and their interaction.

Several tests have been conducted to help us choose the appropriate model for each of the outcome variables. For binary outcomes, logistic models will be constructed. Goodness of fit will then be examined for each model using an *Akaike information criteria* (AIC). Simpler models will also be compared against more complex models using analysis of deviance. Linear models will be constructed for continuous outcomes. Goodness of fit for each model will then be assessed via an adjusted R$^2$. Simpler models will then be compared to more complex models via an analysis of variance.

```{r logisticModels}

logit_p <- function(model){
  p.value <- 1 - pchisq(
  model$null.deviance - model$deviance, 
  model$df.null - model$df.residual
  )
  
  return(p.value)
  
}

model_log <- function(fmla){
  model <- glm(
    formula = fmla,
    data = df.processed,
    family = binomial
  )
  
  return(model)
}

model_all <- function(x){


  model.diet <- model_log(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_diet_groups", sep = "")
  )
  model.diet$p.value <- logit_p(model.diet)
  
  model.exercise <- model_log(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_exercise_groups", sep = "")
  )
  model.exercise$p.value <- logit_p(model.exercise)
  
  
  model.interaction <- model_log(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_diet_groups", " * ", "rtc_exercise_groups", sep = "")
  )
  
  model.interaction$p.value <- logit_p(model.interaction)

  deviance <- list(
    "diet" = anova(model.diet, test = 'Chisq'),
    "exercise" = anova(model.exercise, test = 'Chisq'),
    "interaction" = anova(model.interaction, test = 'Chisq'),
    "dietVinteraction" = anova(model.diet, model.interaction, test = 'Chisq'),
    "exerciseVinteraction" = anova(model.exercise, model.interaction, test = 'Chisq')
  )
  
  b <- list(
    "diet" = model.diet,
    "exercise" = model.exercise,
    "interaction" = model.interaction,
    "ANOD" = deviance
  )
    
  return(b)
}

log_models <- lapply(binary_vars, model_all)

```

```{r linearModels}

model_lm <- function(fmla){
  model <- lm(
    formula = fmla,
    data = df.processed
  )
  
  return(model)
}

model_all <- function(x){


  model.diet <- model_lm(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_diet_groups", sep = "")
  )
  model.diet$p.value <- pf(
          summary(model.diet)$fstatistic[1],
          summary(model.diet)$fstatistic[2],
          summary(model.diet)$fstatistic[3],
          lower = FALSE
       )
  
  model.exercise <- model_lm(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_exercise_groups", sep = "")
  )
  model.exercise$p.value <- pf(
          summary(model.exercise)$fstatistic[1],
          summary(model.exercise)$fstatistic[2],
          summary(model.exercise)$fstatistic[3],
          lower = FALSE
       )
  
  
  model.interaction <- model_lm(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_diet_groups", " * ", "rtc_exercise_groups", sep = "")
  )
  model.interaction$p.value <- pf(
          summary(model.interaction)$fstatistic[1],
          summary(model.interaction)$fstatistic[2],
          summary(model.interaction)$fstatistic[3],
          lower = FALSE
       )

  deviance <- list(
    "diet" = anova(model.diet),
    "exercise" = anova(model.exercise),
    "interaction" = anova(model.interaction),
    "dietVinteraction" = anova(model.diet, model.interaction),
    "exerciseVinteraction" = anova(model.exercise, model.interaction)
  )
  
  b <- list(
    "diet" = model.diet,
    "exercise" = model.exercise,
    "interaction" = model.interaction,
    "ANOVA" = deviance
  )
    
  return(b)
}

linear_models <- lapply(cont_vars, model_all)

```


### Binary Outcomes

#### Lost 7 percent during core

Whether or not a participant was going to lose 7 percent of their body weight during the program could be predicted using either by their readiness to change diet (*p* = `r log_models[["Lost 7 percent during core"]]$diet$p.value`), or their readiness to change exercise (*p* = `r log_models[["Lost 7 percent during core"]]$exercise$p.value`). The interaction did not pass the *a priori* thresholds for significance (*p* = `r log_models[["Lost 7 percent during core"]]$interaction$p.value`).

When comparing the AIC for both models, readiness to change diet (deviance = `r log_models[["Lost 7 percent during core"]]$diet$deviance`; AIC = `r log_models[["Lost 7 percent during core"]]$diet$aic`) is a better predictor of the outcome than readiness to change exercise (deviance = `r log_models[["Lost 7 percent during core"]]$exercise$deviance;` AIC = `r log_models[["Lost 7 percent during core"]]$exercise$aic`).

##### Full Model Estimates

```{r}

a <- "Lost 7 percent during core"

knitr::kable(log_models[[a]]$ANOD$diet) %>% 
   kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 5))

```


##### Individual Beta's

```{r}

knitr::kable(summary(log_models[[a]]$diet)$coefficients) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 4))

```


#### Lost 7 percent overall   

Diet or exercise can be used to predict success either singly (Diet: *p* = `r log_models[["Lost 7 percent overall"]]$diet$p.value`; Exercise: *p* = `r log_models[["Lost 7 percent overall"]]$exercise$p.value`) or as an interaction (`r log_models[["Lost 7 percent overall"]]$interaction$p.value`). Of the three, the interactive model has the smallest deviance (`r log_models[[
"Lost 7 percent overall"]]$interaction$deviance`).

##### Full Model Estimates

```{r}

a <- "Lost 7 percent overall"

knitr::kable(log_models[[a]]$ANOD$interaction) %>% 
   kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 5))

```


##### Individual Beta's

```{r}

knitr::kable(summary(log_models[[a]]$interaction)$coefficients) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 4))

```

#### Lost 5 percent during core

Only readiness to change diet is able to predict a loss of 5% of body weight (*p* = `r log_models[["Lost 5 percent during core"]]$diet$p.value`). Readiness to change exercise or an interaction between teh two do not meet *a priori* threshold for significance.

##### Full Model Estimates

```{r}

a <- "Lost 5 percent during core"

knitr::kable(log_models[[a]]$ANOD$diet) %>% 
   kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 5))

```


##### Individual Beta's

```{r}

knitr::kable(summary(log_models[[a]]$diet)$coefficients) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 4))

```

#### Lost 5 percent overall  

The readiness to change diet overall is also associated with a loss of 5% of body mass (*p* = `r log_models[["Lost 5 percent overall"]]$diet$p.value`), as is the model including an interaction with readiness to change exercise (*p* = `r log_models[["Lost 5 percent overall"]]$interaction$p.value`). Of these two models the latter has the lowest deviance (`r log_models[["Lost 5 percent overall"]]$interaction$deviance`), and the former has the lowest AIC (`r log_models[["Lost 5 percent overall"]]$diet$aic`). An analysis of deviance confirms that these models are essentially equivalent (deviance = `r log_models[["Lost 5 percent overall"]]$ANOD$dietVinteraction$Deviance[2]` and *p* = `r log_models[["Lost 5 percent overall"]]$ANOD$dietVinteraction[["Pr(>Chi)"]][2]`). In such a case, the simpler model is the best choice.

##### Full Model Estimates

```{r}

a <- "Lost 5 percent overall"

knitr::kable(log_models[[a]]$ANOD$diet) %>% 
   kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 5))

```


##### Individual Beta's

```{r}

knitr::kable(summary(log_models[[a]]$diet)$coefficients) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c("Readiness to Change Diet" = 1, " " = 4))

```

#### Met fat goal

None of the models were adequately associated with meeting fat goals.

#### Met exercise goal at least 50 percent

None of the models were adequately associated with meeting exercise goals.


### Continuous Outcomes

#### Core attendance

Core attendance can be predicted by readiness to change diet (*p* = `r linear_models[["Core attendance"]]$diet$p.value`) or exercise (*p* = `r linear_models[["Core attendance"]]$exercise$p.value`). Readiness to change exercise offers the highest adjusted R$^2$ (`r summary(linear_models[["Core attendance"]]$exercise)$adj.r.squared`).

```{r}

knitr::kable(summary(linear_models[["Core attendance"]]$exercise)$coefficients) %>%  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

```


#### Post-core attendance

None of the models meet *a priori* thresholds for significance.

#### Overall attendance

Overall attendance can be modelled using either readiness to change diet (*p* = `r linear_models[["Overall attendance"]]$diet$p.value`) or exercise (`r linear_models[["Overall attendance"]]$exercise$p.value`). Diet offers the highest adjusted R$^2$ (`r summary(linear_models[["Overall attendance"]]$diet)$adj.r.squared`).

```{r}

knitr::kable(summary(linear_models[["Overall attendance"]]$diet)$coefficients) %>%  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

```

#### Maximum weight lost

Of the three possible models, only diet passed the *a priori* thresholds of significance (`r linear_models[["Maximum weight lost"]]$diet$p.value`).

```{r}

knitr::kable(summary(linear_models[["Maximum weight lost"]]$diet)$coefficients) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

```

#### Percent weight lost

Of the three possible models, only diet passed the *a priori* thresholds of significance (`r linear_models[["Percent weight lost"]]$diet$p.value`).

```{r}

knitr::kable(summary(linear_models[["Percent weight lost"]]$diet)$coefficients) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

```

#### Met fat goal (percentage of sessions)

None of the models met *a priori* significance thresholds.

#### Met exercise goal (percentage of sessions)

None of the models met *a priori* significance thresholds.

### Considering the Models

While models proved to be statistically significant for many of the outcomes, none performed well. The best logistic models achieved an AIC above 200 (smaller is better) and the best linear models achieved an adjusted R$^2$ near 0.03. At best, these models are only useful for describing theoretical relationships, but are not useful in any practical application. This is probably due to the unbalanced nature of the data (i.e. participants were primarily in the preparation stage of both scales).

# Core Completers

Did completing the 16 core sessions predict anything?

```{r}
df.processed <- df.processed %>% 
  mutate(
    core_completion = ifelse(
      `Core attendance` >= 16,
      "Complete",
      "Incomplete"
    )
  )

comp_tab <- compareGroups::compareGroups(core_completion ~ .- rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet - Include - `Core attendance`,
                             data = df.processed)

compareGroups::createTable(
  comp_tab,
  show.p.overall = FALSE
) %>% 
  compareGroups::export2md(
    caption = "A comparison of participants according to whether they completed the 16 core sessions."
    )

```

## Categorical variables

Categorical variables (i.e. variables that were nominal rather than quantitative in nature) were examined in relation to whether they completed the 16 core sessions using a Pearson's chi-square analysis. What follows are the reported $\chi^2$ statistics, degrees of freedom, and p-values from each test.

```{r}
binary_vars <- list(
  "Lost 7 percent during core" = "Lost 7 percent during core",
  "Lost 7 percent overall" = "Lost 7 percent overall",
  "Lost 5 percent during core" = "Lost 5 percent during core",
  "Lost 5 percent overall" = "Lost 5 percent overall",
  "Met fat goal" = "Met fat goal",
  "Met exercise goal at least 50 percent" = "Met exercise goal at least 50 percent"
  )

chi_diet <- function(x){
  chisq <- chisq.test(
    df.processed$core_completion,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.diet <- lapply(binary_vars, chi_diet)

df.stats <- data.frame(
  "Variable"=character(),
  "X-squared"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(chis.diet)){
  row.to.add <- data.frame(
    "Variable" = i,
    "X-squared" = chis.diet[[i]]$statistic,
    "df" = chis.diet[[i]]$parameter,
    "p-value" = chis.diet[[i]]$p.value,
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

# graphs

df.processed %>% 
  tidyr::gather(
    key = Variables,
    value = Value,
    c(
      "Lost 7 percent during core",
      "Lost 7 percent overall",
      "Lost 5 percent during core",
      "Lost 5 percent overall",
      "Met fat goal",
      "Met exercise goal at least 50 percent"
      )
  ) %>% 
  ggplot(
    aes(core_completion)
  ) +
  geom_bar(
    aes(fill = Value),
    position = "fill",
    alpha = 0.8
  ) +
  facet_wrap("Variables") +
  theme_classic() +
  labs(
    title = "Proportion of Patients Achieving Program Goals",
    x = "Core Completion Status",
    y = "Proportion",
    fill = "Did They Meet Goal?"
  )


```

## Continuous variables

The effect of completing the core sessions on quantitative measures were examined using via an analysis of variance. The appropriate statistics from each test are found below.

```{r}

cont_vars <- list(
  "Post-core attendance" = 
    "Post-core attendance",
  "Overall attendance" = 
    "Overall attendance",
  "Maximum weight lost" = 
    "Maximum weight lost",
  "Percent weight lost" = 
    "Percent weight lost",
  "Met fat goal (percentage of sessions)" = 
    "Met fat goal (percentage of sessions)",
  "Met exercise goal (percentage of sessions)" = 
    "Met exercise goal (percentage of sessions)"
)

aov_readiness <- function(x, y){
  aov.results <- aov(
    df.processed[[x]] ~ df.processed[[y]],
    data = df.processed
      )
  
  return(aov.results)
}

aov_diet <- lapply(cont_vars, aov_readiness, y = "rtc_diet_groups")

# lapply(aov_diet, summary)

df.stats <- data.frame(
  "Variable"=character(),
  "F-statistic"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(aov_diet)){
  a <- summary(aov_diet[[i]])
  row.to.add <- data.frame(
    "Variable" = i,
    "F-statistic" = a[[1]]$`F value`[1],
    "df" = a[[1]]$`Df`[1],
    "p-value" = a[[1]]$`Pr(>F)`[1],
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  tidyr::gather(
    key = Variables,
    value = Value,
    c(
      "Post-core attendance",
      "Overall attendance",
      "Maximum weight lost",
      "Percent weight lost",
      "Met fat goal (percentage of sessions)",
      "Met exercise goal (percentage of sessions)"
      )
  ) %>% 
  ggplot(
    aes(core_completion, Value)
  ) +
  geom_boxplot() +
  facet_wrap(
    "Variables",
    scales = "free"
    ) +
  theme_classic() +
  labs(
    title = "Continuous Outcomes for Completers v. Non-Completers",
    x = "Group",
    y = ""
  )

```

## Summary

Overall it appears that completing the core of the program is a good indicator of meeting other goals in the program. The question remains as to why. Do individuals complete the core because they are meeting their goals or do individuals meet their goals because they complete the core? The only way to answer this question is with extensive follow up and interviewing of participants to rule out the possibility of self-selection (i.e. individuals only complete the core if they see progress).

# Post-hoc Analysis

```{r}

df.post <- df.processed %>%
  mutate(
    rtc_diet_groups = ifelse(
      rtc_diet == "preparation" | 
        rtc_diet == "contemplative" |
        rtc_diet == "precontemplative",
      "preparation",
        ifelse(
          rtc_diet == "maintain" | 
            rtc_diet == "action",
          "action",
          NA
        )
    ),
    rtc_exercise_groups = ifelse(
      rtc_exercise == "preparation" | 
        rtc_exercise == "contemplative" |
        rtc_diet == "precontemplative",
      "preparation",
        ifelse(
          rtc_exercise == "maintain" | 
            rtc_exercise == "action",
          "action",
          NA
        )
    )
  )

cross.both <- chisq.test(
  df.post$rtc_diet_groups,
  df.post$rtc_exercise_groups,
  correct = TRUE
  )

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  return(as.numeric(CV))
}

CV <- cv.test(
  df.post$rtc_diet_groups,
  df.post$rtc_exercise_groups
  )

```

Readiness to change responses were used to create aggregate groups. Individuals self-classifying as 'Precontemplative', 'Contemplative' or 'Preparation' were grouped together and individuals self-classifying as 'Action' or 'Maintain' were grouped together. The models were then recreated with the new groups. Doing so reduced Cramer's V to `r CV`, resulting in a moderate association between the two readiness to change questions ($\chi^2$ = `r cross.both$statistic`, *p* = `r cross.both$p.value`).

```{r}
knitr::kable(cross.both$observed, caption = "New Group Tallies") %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    ) %>% 
  kableExtra::add_header_above(c(" " = 1, "Readiness to Change Exercise" = 2)) %>% 
  kableExtra::pack_rows("Readiness to Change Diet", 1, 2)
```

```{r newMods}

logit_p <- function(model){
  p.value <- 1 - pchisq(
  model$null.deviance - model$deviance, 
  model$df.null - model$df.residual
  )
  
  return(p.value)
  
}

model_log <- function(fmla){
  model <- glm(
    formula = fmla,
    data = df.post,
    family = binomial
  )
  
  return(model)
}

model_all <- function(x){


  model.diet <- model_log(
    paste("df.post[['", x, "']]", 
          " ~ ", "rtc_diet_groups", sep = "")
  )
  model.diet$p.value <- logit_p(model.diet)
  
  model.exercise <- model_log(
    paste("df.post[['", x, "']]", 
          " ~ ", "rtc_exercise_groups", sep = "")
  )
  model.exercise$p.value <- logit_p(model.exercise)
  
  
  model.interaction <- model_log(
    paste("df.post[['", x, "']]", 
          " ~ ", "rtc_diet_groups", " * ", "rtc_exercise_groups", sep = "")
  )
  
  model.interaction$p.value <- logit_p(model.interaction)
  
  b <- list(
    "diet" = model.diet,
    "exercise" = model.exercise,
    "interaction" = model.interaction
  )
    
  return(b)
}

log_post <- lapply(binary_vars, model_all)



model_lm <- function(fmla){
  model <- lm(
    formula = fmla,
    data = df.post
  )
  
  return(model)
}

model_all <- function(x){


  model.diet <- model_lm(
    paste("df.post[['", x, "']]", 
          " ~ ", "rtc_diet_groups", sep = "")
  )
  model.diet$p.value <- pf(
          summary(model.diet)$fstatistic[1],
          summary(model.diet)$fstatistic[2],
          summary(model.diet)$fstatistic[3],
          lower = FALSE
       )
  
  model.exercise <- model_lm(
    paste("df.post[['", x, "']]", 
          " ~ ", "rtc_exercise_groups", sep = "")
  )
  model.exercise$p.value <- pf(
          summary(model.exercise)$fstatistic[1],
          summary(model.exercise)$fstatistic[2],
          summary(model.exercise)$fstatistic[3],
          lower = FALSE
       )
  
  
  model.interaction <- model_lm(
    paste("df.post[['", x, "']]", 
          " ~ ", "rtc_diet_groups", " * ", "rtc_exercise_groups", sep = "")
  )
  model.interaction$p.value <- pf(
          summary(model.interaction)$fstatistic[1],
          summary(model.interaction)$fstatistic[2],
          summary(model.interaction)$fstatistic[3],
          lower = FALSE
       )
  
  b <- list(
    "diet" = model.diet,
    "exercise" = model.exercise,
    "interaction" = model.interaction
  )
    
  return(b)
}

linear_post <- lapply(cont_vars, model_all)

for(nom in names(log_post)){
  for(nomy in names(log_post[[nom]])){
    
    if(log_post[[nom]][[nomy]]$p.value <= 0.05){
      print(
        paste(nom, nomy, sep = ": ")
      )
      print(log_post[[nom]][[nomy]]$p.value)
    }
  }
}

for(nom in names(linear_post)){
  for(nomy in names(linear_post[[nom]])){
    if(linear_post[[nom]][[nomy]]$p.value <= 0.05){
      print(
        paste(nom, nomy, sep = ": ")
      )
      print(linear_post[[nom]][[nomy]]$p.value)
    }
  }
}

```

Post-hoc models were then constructed. Performance of the post-hoc models was less than the preliminary analysis. Of all the models tested, only three were statistically significant. Logistic models using only readiness to change exercise were associated with whether an individual lost seven percent of body mass during core (AIC = `r log_post[["Lost 7 percent during core"]]$exercise$aic`, *p* = `r log_post[["Lost 7 percent during core"]]$exercise$p.value`) and losing seven percent overall (AIC = `r log_post[["Lost 7 percent overall"]]$exercise$aic`,*p* = `r log_post[["Lost 7 percent overall"]]$exercise$p.value`). A linear model using exercise was significant for percent weight lost (R$^2$ = `r summary(linear_post[["Percent weight lost"]]$exercise)$adj.r.squared`, *p* = `r linear_post[["Percent weight lost"]]$exercise$p.value`). This is a marked reduction in the number of models meeting *a priori* significance and without improved model fit (the AIC and R$^2$ values are essentially the same as before).

# Discussion

asdf


