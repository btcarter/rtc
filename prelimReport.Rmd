---
title: "Readiness to Change"
author: "Benjamin Carter"
date: "6/20/2020"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_float: yes
  slidy_presentation:
    incremental: yes
  ioslides_presentation:
    incremental: yes
    widescreen: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)
library(dplyr)
library(tidyr)
library(gmodels)
library(ggplot2)
# paths V:\Depts\CtrTransRsch\Dept Private\CTR Staff\PROJECT - Readiness to change manuscript\DATA
data.dir.path <- file.path(
  "V:",
  "Depts", 
  "CtrTransRsch", 
  "Dept Private", 
  "CTR Staff", 
  "PROJECT - Readiness to change manuscript", 
  "DATA"
  )
```

```{r loadData, include=FALSE}
df <- readxl::read_xlsx(
  file.path(data.dir.path, "Nick_Rural16_OAT 6-11-20.xlsx")
  )

```


```{r selection, include=FALSE}
df.processed <- df %>% 
  mutate(
    Gender = ifelse(
      Gender == 1,
      "Female",
      "Male"
      ),
    rtc_diet = ifelse(
      `1a_pre` == 1,
      "precontemplative",
      ifelse(
        `1a_pre` == 2,
        "contemplative",
        ifelse(
          `1a_pre` == 3,
          "preparation",
          ifelse(
            `1a_pre` == 4,
            "action",
            ifelse(
              `1a_pre` == 5,
              "maintain",
              `1a_pre`
            )
          )
        )
      )
    ),
    rtc_exercise = ifelse(
      `2a_pre` == 1,
      "precontemplative",
      ifelse(
        `2a_pre` == 2,
        "contemplative",
        ifelse(
          `2a_pre` == 3,
          "preparation",
          ifelse(
            `2a_pre` == 4,
            "action",
            ifelse(
              `2a_pre` == 5,
              "maintain",
              `2a_pre`
            )
          )
        )
      )
    ),
    rtc_diet_groups = ifelse(
      `1a_pre` == 1,
      "Pre/Contemplative",
      ifelse(
        `1a_pre` == 2,
        "Pre/Contemplative",
        ifelse(
          `1a_pre` == 3,
          "Preparation",
          ifelse(
            `1a_pre` == 4,
            "Action",
            ifelse(
              `1a_pre` == 5,
              "Maintain",
              `1a_pre`
            )
          )
        )
      )
    ),
    rtc_exercise_groups = ifelse(
    `2a_pre` == 1,
    "Pre/Contemplative",
    ifelse(
      `2a_pre` == 2,
      "Pre/Contemplative",
      ifelse(
        `2a_pre` == 3,
        "Preparation",
        ifelse(
          `2a_pre` == 4,
          "Action",
          ifelse(
            `2a_pre` == 5,
            "Maintain",
            `2a_pre`
          )
        )
      )
    )
  ),
  Include = ifelse(
    is.na(`1a_pre`) |
      is.na(`2a_pre`),
    "FALSE",
    "TRUE"
  ),
  MaxWeightLost = MaxWeightLost*-1
) %>% 
  select(
    rtc_diet,
    rtc_diet_groups,
    rtc_exercise,
    rtc_exercise_groups,
    Include,
    Gender,
    Age,
    `Start weight` = Todays_Weight,
    BMI,
    `Maximum weight lost` = MaxWeightLost,
    `Percent weight lost` = pWeightLost,
    `Lost 7 percent during core` = Met7GoalCore,
    `Lost 7 percent overall` = Met7GoalOVL,
    `Lost 5 percent during core` = Met5GoalCore,
    `Lost 5 percent overall` = Met5GoalOVL,
    `Core attendance` = Core,
    `Post-core attendance` = AfterCore,
    `Overall attendance` = `Number of Sessions`,
    `Met fat goal` = FatGramGoalMet,
    `Met fat goal (percentage of sessions)` = Met_Fat_Gram,
    `Met exercise goal at least 50 percent` = Exercise_Goal_50_Met,
    `Met exercise goal (percentage of sessions)` = Met_Activity_Goal
  ) %>% 
  mutate(
    rtc_diet_groups = as.factor(
      rtc_diet_groups
      ),
    rtc_exercise_groups = as.factor(
      rtc_exercise_groups
      ),
    `Lost 7 percent during core` = ifelse(
      `Lost 7 percent during core` == 1,
      TRUE,
      FALSE
      ),
    `Lost 7 percent overall` = ifelse(
      `Lost 7 percent overall` == 1,
      TRUE,
      FALSE
      ),
    `Lost 5 percent during core` = ifelse(
      `Lost 5 percent during core` == 1,
      TRUE,
      FALSE
    ),
    `Lost 5 percent overall` = ifelse(
      `Lost 5 percent overall` == 1,
      TRUE,
      FALSE
    ),
    `Met fat goal` = ifelse(
      `Met fat goal` == 1,
      TRUE,
      FALSE
    ),
    `Met exercise goal at least 50 percent` = ifelse(
      `Met exercise goal at least 50 percent` == 1,
      TRUE,
      FALSE
    )
  )

df.processed$rtc_diet_groups <- factor(
  df.processed$rtc_diet_groups,
  levels = c("Pre/Contemplative", "Preparation", "Action", "Maintain")
  )

df.processed$rtc_exercise_groups <- factor(
  df.processed$rtc_exercise_groups,
  levels = c("Pre/Contemplative", "Preparation", "Action", "Maintain")
  )

```

# Primary Analysis
## Descriptives

### Included vs Excluded individuals

```{r message=FALSE, warning=FALSE}
tab1 <- compareGroups::compareGroups(
  Include ~ .- rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet,
  df.processed
  )

compareGroups::createTable(
  tab1,
  show.p.overall = FALSE
  ) %>% 
  compareGroups::export2md()

```

### Included only

```{r}
df.processed <- df.processed %>% 
  filter(
    Include == "TRUE"
  )

tab1 <- compareGroups::compareGroups(
   ~ . - Include - rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet,
  df.processed
  )

compareGroups::createTable(
  tab1,
  show.n = FALSE
  ) %>% 
  compareGroups::export2md()
```


## RTC Categorical Variables

Categorical variables (i.e. variables that were nominal rather than quantitative in nature) were examined in relation to readiness to change diet or exercise using a Pearson's chi-square analysis. What follows are the reported $\chi^2$ statistics, degrees of freedom, and p-values from each test.

### Diet

```{r categoricals, message=FALSE,warning=FALSE,echo=FALSE}

binary_vars <- list(
  "Lost 7 percent during core" = "Lost 7 percent during core",
  "Lost 7 percent overall" = "Lost 7 percent overall",
  "Lost 5 percent during core" = "Lost 5 percent during core",
  "Lost 5 percent overall" = "Lost 5 percent overall",
  "Met fat goal" = "Met fat goal",
  "Met exercise goal at least 50 percent" = "Met exercise goal at least 50 percent"
  )

chi_diet <- function(x){
  chisq <- chisq.test(
    df.processed$rtc_diet_groups,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.diet <- lapply(binary_vars, chi_diet)

df.stats <- data.frame(
  "Variable"=character(),
  "X-squared"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(chis.diet)){
  row.to.add <- data.frame(
    "Variable" = i,
    "X-squared" = chis.diet[[i]]$statistic,
    "df" = chis.diet[[i]]$parameter,
    "p-value" = chis.diet[[i]]$p.value,
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_diet_groups,
      fill = Val
    )
  ) +
  geom_bar(
    position = "fill"
  ) + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Diet",
    y = "Proportion of Group",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_diet_groups,
      fill = Val
    )
  ) +
  geom_bar() + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Diet",
    y = "Count",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

```

### Exercise

```{r}

chi_exercise <- function(x){
  chisq <- chisq.test(
    df.processed$rtc_exercise_groups,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.exercise <- lapply(binary_vars, chi_exercise)

df.stats <- data.frame(
  "Variable"=character(),
  "X-squared"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(chis.exercise)){
  row.to.add <- data.frame(
    "Variable" = i,
    "X-squared" = chis.exercise[[i]]$statistic,
    "df" = chis.exercise[[i]]$parameter,
    "p-value" = chis.exercise[[i]]$p.value,
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_exercise_groups,
      fill = Val
    )
  ) +
  geom_bar(
    position = "fill"
  ) + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Exercise",
    y = "Proportion of Group",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(
      names(
        binary_vars
      )
    )
  ) %>% 
  ggplot(
    aes(
      rtc_exercise_groups,
      fill = Val
    )
  ) +
  geom_bar() + 
  theme_classic() +
  theme(
    axis.text.x = element_text(angle = 90)
  ) +
  labs(
    title = "Which Groups Met Their Goals?",
    x = "Readiness to Change Exercise",
    y = "Count",
    fill = "Met Goal"
  ) +
  facet_wrap(Outcome~.)

```

## RTC Continuous Variables

The effect of readiness to change on quantitative measures were examined using via an analysis of variance. The appropriate statistics from each test are found below.

### Diet

```{r continuous, message=FALSE}

cont_vars <- list(
  "Core attendance" = 
    "Core attendance",
  "Post-core attendance" = 
    "Post-core attendance",
  "Overall attendance" = 
    "Overall attendance",
  "Maximum weight lost" = 
    "Maximum weight lost",
  "Percent weight lost" = 
    "Percent weight lost",
  "Met fat goal (percentage of sessions)" = 
    "Met fat goal (percentage of sessions)",
  "Met exercise goal (percentage of sessions)" = 
    "Met exercise goal (percentage of sessions)"
)

aov_readiness <- function(x, y){
  aov.results <- aov(
    df.processed[[x]] ~ df.processed[[y]],
    data = df.processed
      )
  
  return(aov.results)
}

aov_diet <- lapply(cont_vars, aov_readiness, y = "rtc_diet_groups")

#lapply(aov_diet, summary)

df.stats <- data.frame(
  "Variable"=character(),
  "F-statistic"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(aov_diet)){
  a <- summary(aov_diet[[i]])
  row.to.add <- data.frame(
    "Variable" = i,
    "F-statistic" = a[[1]]$`F value`[1],
    "df" = a[[1]]$`Df`[1],
    "p-value" = a[[1]]$`Pr(>F)`[1],
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(names(cont_vars))
  ) %>% 
  ggplot(
    aes(
      rtc_diet_groups,
      Val
    )
  ) +
  geom_boxplot() +
  facet_wrap(Outcome~., ncol = 4, scales = "free") +
  theme_classic() +
  labs(
    title = "Who Met Their Goal?",
    x = "Readiness to Change Diet",
    y = "Measure"
  ) +
  theme(
    axis.text.x = element_text(angle = 90)
  )

```

### Exercise

```{r continuous2}

aov_exercise <- lapply(cont_vars, aov_readiness, y = "rtc_exercise_groups")

# lapply(aov_exercise, summary)

df.stats <- data.frame(
  "Variable"=character(),
  "F-statistic"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(aov_exercise)){
  a <- summary(aov_exercise[[i]])
  row.to.add <- data.frame(
    "Variable" = i,
    "F-statistic" = a[[1]]$`F value`[1],
    "df" = a[[1]]$`Df`[1],
    "p-value" = a[[1]]$`Pr(>F)`[1],
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(names(cont_vars))
  ) %>% 
  ggplot(
    aes(
      rtc_exercise_groups,
      Val
    )
  ) +
  geom_boxplot() +
  facet_wrap(Outcome~., ncol = 4, scales = "free") +
  theme_classic() +
  labs(
    title = "Who Met Their Goal?",
    x = "Readiness to Change Exercise",
    y = "Measure"
  ) +
  theme(
    axis.text.x = element_text(angle = 90)
  )

df.processed %>% 
  gather(
    key = "Outcome",
    value = "Val",
    c(names(binary_vars))
  ) %>% 
  ggplot(
    aes(
      Outcome,
      fill = Val
    )
  ) +
  geom_bar(
    position = "fill"
  ) +
  facet_grid(
    rtc_exercise_groups ~ rtc_diet_groups,
    labeller = label_both
  ) +
  theme_classic() +
  labs(
    title = "Readiness to Change Success",
    x = "Goal Achieved?",
    y = "Count"
  )  +
  theme(
    axis.text.x = element_text(angle = 90)
  )

```

## Potential interaction in RTC

```{r interactions}

cross.both <- chisq.test(
  df.processed$rtc_diet_groups,
  df.processed$rtc_exercise_groups,
  correct = TRUE
  )

cv.test = function(x,y) {
  CV = sqrt(chisq.test(x, y, correct=FALSE)$statistic /
    (length(x) * (min(length(unique(x)),length(unique(y))) - 1)))
  return(as.numeric(CV))
}

CV <- cv.test(
  df.processed$rtc_diet_groups,
  df.processed$rtc_exercise_groups
  )

```

Responses to the readiness to change questions are probably related correlated. This would make sense as individuals who are willing to change their diet are probably more likely to change their exercise as well. The converse is probably also true. Cramer's V between both questions is `r CV`. This indicates there is a relatively large association between readiness to change diet and readiness to change exercise. This association can be treated in one of two ways: it can be used to simplify the predictive model (i.e. because the responses to the questions are correlated we need only consider the responses to one of the questions and can ignore the other) or this can be included as an interaction in a multivariate model.

```{r}
knitr::kable(
  as.data.frame(cross.both$observed) %>% tidyr::spread(key = Var2, value = Freq)) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

```

## Predictive models for success

Now we can revisit the models from the preliminary analysis. Given the interaction in readiness to change survey responses, there are essentially three different forms our model can take: (1) a model with a single term representing the response to only one of the readiness to change questions, (2) a model with two terms using both readiness to change questions and their interaction, (3) a model using the readiness to change survey and demographic factors.

Several tests will be conducted to help us choose the appropriate model for each of the outcome variables. For binary outcome variables, logistic models will be constructed. Goodness of fit will then be examined for each model against the null hypothesis using analysis of deviance. Simpler models will also be compared against more complex models using analysis of deviance. This will enable us to quantify the difference between models in terms of goodness of fit and the odds these differences are due to chance.

After the models are compared, $\beta$ values for model coefficients and *p*-values are presented. Logistic model performance is also quantified using an *Akaike information criteria* (AIC) for the logistic models, and R$^2$ for the linear models.

This is followed by a discussion summarizing the results.

### Binary outcomes

```{r}

logit_p <- function(model){
  p.value <- 1 - pchisq(
  model$null.deviance - model$deviance, 
  model$df.null - model$df.residual
  )
  
  return(p.value)
  
}

model_log <- function(fmla){
  model <- glm(
    formula = fmla,
    data = df.processed,
    family = binomial
  )
  
  return(model)
}

model_all <- function(x){


  model.diet <- model_log(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_diet_groups", sep = "")
  )
  model.diet$p.value <- logit_p(model.diet)
  
  model.exercise <- model_log(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_exercise_groups", sep = "")
  )
  model.exercise$p.value <- logit_p(model.exercise)
  
  
  model.interaction <- model_log(
    paste("df.processed[['", x, "']]", 
          " ~ ", "rtc_diet_groups", " * ", "rtc_exercise_groups", sep = "")
  )
  
  model.interaction$p.value <- logit_p(model.interaction)

  deviance <- list(
    "diet" = anova(model.diet, test = 'Chisq'),
    "exercise" = anova(model.exercise, test = 'Chisq'),
    "interaction" = anova(model.interaction, test = 'Chisq'),
    "dietVexercise" = anova(model.diet, model.exercise, test = 'Chisq'),
    "dietVinteraction" = anova(model.diet, model.interaction, test = 'Chisq'),
    "exerciseVinteraction" = anova(model.exercise, model.interaction, test = 'Chisq')
  )
  
  b <- list(
    "diet" = model.diet,
    "exercise" = model.exercise,
    "interaction" = model.interaction,
    "ANOD" = deviance
  )
    
  return(b)
}

log_models <- lapply(binary_vars, model_all)

```

```{r}
for (mod in names(log_models)){
  # print name
  print("=========================================================")
  print(
    paste(
      "Outcome:",
      mod,
      sep = ""
    )
  )
  print("=========================================================")

  # print individual model coefficients and overall model p-values
  model_list <- c("diet", "exercise", "interaction")
  
  for (thing in model_list){
    
    print(
      paste(
        "Predictor:",
        " ",
        thing,
        sep = ""
      )
    )
    
    print(
      paste(
        "AIC: ",
        log_models[[mod]][[thing]]$aic,
        ", ",
        "p-value: ",
        log_models[[mod]][[thing]]$p.value,
        sep = "" 
      )
    )
    
    print(
      as.data.frame(
        summary(log_models[[mod]][[thing]])$coefficients[,c(1,4)]
      )  
    )
    
    print("-----------------------------------------------------")
    

  }
  
  
  # print deviance tables to choose models
  
  print("=========================================================")
  
  print("Model comparisons via analysis of deviance")
  
  for (tab in names(log_models[[mod]]$ANOD)){
    print(
      paste(
        "Comparison: ",
        tab,
        sep = ""
      )
    )
    print(
        as.data.frame(log_models[[mod]]$ANOD[[tab]])
    )
    print("-----------------------------------------------------")
  }
  
}
```



### Continuous outcomes

#### Simple

```{r}

model_lm <- function(x){
  
  model <- lm(
    formula = 
      df.processed[[x]] ~ 
      rtc_diet_groups + 
      rtc_exercise_groups, 
    data = df.processed
    )
}

linear_simple <- lapply(cont_vars, model_lm)

```

##### Core attendance

```{r}
a <- "Core attendance"
r <- summary(linear_simple[[a]])$adj.r.squared
b <- summary(linear_simple[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Post-core attendance


```{r}
a <- "Post-core attendance"
r <- summary(linear_simple[[a]])$adj.r.squared
b <- summary(linear_simple[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Overall attendance

```{r}
a <- "Overall attendance"
r <- summary(linear_simple[[a]])$adj.r.squared
b <- summary(linear_simple[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Maximum weight lost

```{r}
a <- "Maximum weight lost"
r <- summary(linear_simple[[a]])$adj.r.squared
b <- summary(linear_simple[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Percent weight lost

```{r}
a <- "Percent weight lost"
r <- summary(linear_simple[[a]])$adj.r.squared
b <- summary(linear_simple[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Met fat goal (percentage of sessions)

```{r}
a <- "Met fat goal (percentage of sessions)"
r <- summary(linear_simple[[a]])$adj.r.squared
b <- summary(linear_simple[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Met exercise goal (percentage of sessions)

```{r}
a <- "Met exercise goal (percentage of sessions)"
r <- summary(linear_simple[[a]])$adj.r.squared
b <- summary(linear_simple[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

#### Complex

```{r}

model_lm <- function(x){
  
  model <- lm(
    formula = 
      df.processed[[x]] ~ 
      rtc_diet_groups * 
      rtc_exercise_groups +
      Age +
      Gender +
      BMI, 
    data = df.processed
    )
}

linear_complex <- lapply(cont_vars, model_lm)

```

##### Core attendance

```{r}
a <- "Core attendance"
r <- summary(linear_complex[[a]])$adj.r.squared
b <- summary(linear_complex[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Post-core attendance


```{r}
a <- "Post-core attendance"
r <- summary(linear_complex[[a]])$adj.r.squared
b <- summary(linear_complex[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Overall attendance

```{r}
a <- "Overall attendance"
r <- summary(linear_complex[[a]])$adj.r.squared
b <- summary(linear_complex[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Maximum weight lost

```{r}
a <- "Maximum weight lost"
r <- summary(linear_complex[[a]])$adj.r.squared
b <- summary(linear_complex[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Percent weight lost

```{r}
a <- "Percent weight lost"
r <- summary(linear_complex[[a]])$adj.r.squared
b <- summary(linear_complex[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Met fat goal (percentage of sessions)

```{r}
a <- "Met fat goal (percentage of sessions)"
r <- summary(linear_complex[[a]])$adj.r.squared
b <- summary(linear_complex[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```

##### Met exercise goal (percentage of sessions)

```{r}
a <- "Met exercise goal (percentage of sessions)"
r <- summary(linear_complex[[a]])$adj.r.squared
b <- summary(linear_complex[[a]])$coefficients
```

R$^2$: `r r`

```{r}
knitr::kable(
  b
) %>% 
  kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))
```


### Predictive Model Summary

Overall the models perform poorly, however some perform better than the null hypothesis (see tables below).

```{r}
# assemble dataframe with outcome variables and model results

# performance <- data.frame(
#   "Outcome" = character(),
#   "Complexity" = character(),
#   "AIC" = numeric(),
#   "p-value" = numeric()
# )
# 
# for (var in binary_vars){
#   
#   performance <- rbind(
#     performance,
#     data.frame(
#       "Outcome" = var,
#       "Complexity" = "Simple",
#       "AIC" = log_simple[[var]]$model$aic,
#       "p-value" = log_simple[[var]]$p
#     )
#   )
#   
#   aic <- log_complex[[var]]$model$aic
#   
#   performance <- rbind(
#     performance,
#     data.frame(
#       "Outcome" = var,
#       "Complexity" = "Complex",
#       "AIC" = aic,
#       "p-value" = log_complex[[var]]$p
#     )
#   )
# }
# 
# knitr::kable(
#   performance,
#   caption = "Logistic model performance."
# ) %>% 
#   kableExtra::collapse_rows(
#     columns = 1, valign = "top"
#   ) %>% 
#   kableExtra::kable_styling(bootstrap_options = c("striped", "hover", "condensed", "responsive"))

# linear model performance summary

performance <- data.frame(
  "Outcome" = character(),
  "Complexity" = character(),
  "R-squared" = numeric(),
  "p-value" = numeric()
)

for (var in cont_vars){
  
  aic <- summary(linear_simple[[var]])$adj.r.squared
  
  performance <- rbind(
    performance,
    data.frame(
      "Outcome" = var,
      "Complexity" = "Simple",
      "R-squared" = aic,
      "p-value" = pf(
         summary(linear_simple[[var]])$fstatistic[1],
         summary(linear_simple[[var]])$fstatistic[2],
         summary(linear_simple[[var]])$fstatistic[3],
         lower = FALSE
      ),
      row.names = NULL
    )
  )
  
  aic <- summary(linear_complex[[var]])$adj.r.squared
  
  performance <- rbind(
    performance,
    data.frame(
      "Outcome" = var,
      "Complexity" = "Complex",
      "R-squared" = aic,
      "p-value" = pf(
         summary(linear_complex[[var]])$fstatistic[1],
         summary(linear_complex[[var]])$fstatistic[2],
         summary(linear_complex[[var]])$fstatistic[3],
         lower = FALSE
      ),
      row.names = NULL
    )
  )
}

knitr::kable(
  performance,
  caption = "Linear model performance when predicting outcome variables."
) %>% 
  kableExtra::collapse_rows(
    columns = 1, valign = "top"
  ) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed", "responsive"))

```


# Core Completers

Did completing the 16 core sessions predict anything?

```{r}
df.processed <- df.processed %>% 
  mutate(
    core_completion = ifelse(
      `Core attendance` >= 16,
      "Complete",
      "Incomplete"
    )
  )

comp_tab <- compareGroups::compareGroups(core_completion ~ .- rtc_diet_groups - rtc_exercise - rtc_exercise_groups - rtc_diet - Include - `Core attendance`,
                             data = df.processed)

compareGroups::createTable(
  comp_tab,
  show.p.overall = FALSE
) %>% 
  compareGroups::export2md(
    caption = "A comparison of participants according to whether they completed the 16 core sessions."
    )

```

## Categorical variables

Categorical variables (i.e. variables that were nominal rather than quantitative in nature) were examined in relation to whether they completed the 16 core sessions using a Pearson's chi-square analysis. What follows are the reported $\chi^2$ statistics, degrees of freedom, and p-values from each test.

```{r}
binary_vars <- list(
  "Lost 7 percent during core" = "Lost 7 percent during core",
  "Lost 7 percent overall" = "Lost 7 percent overall",
  "Lost 5 percent during core" = "Lost 5 percent during core",
  "Lost 5 percent overall" = "Lost 5 percent overall",
  "Met fat goal" = "Met fat goal",
  "Met exercise goal at least 50 percent" = "Met exercise goal at least 50 percent"
  )

chi_diet <- function(x){
  chisq <- chisq.test(
    df.processed$core_completion,
    df.processed[[x]],
    correct = TRUE
  )
  return(chisq)
}

chis.diet <- lapply(binary_vars, chi_diet)

df.stats <- data.frame(
  "Variable"=character(),
  "X-squared"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(chis.diet)){
  row.to.add <- data.frame(
    "Variable" = i,
    "X-squared" = chis.diet[[i]]$statistic,
    "df" = chis.diet[[i]]$parameter,
    "p-value" = chis.diet[[i]]$p.value,
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

# graphs

df.processed %>% 
  tidyr::gather(
    key = Variables,
    value = Value,
    c(
      "Lost 7 percent during core",
      "Lost 7 percent overall",
      "Lost 5 percent during core",
      "Lost 5 percent overall",
      "Met fat goal",
      "Met exercise goal at least 50 percent"
      )
  ) %>% 
  ggplot(
    aes(core_completion)
  ) +
  geom_bar(
    aes(fill = Value),
    position = "fill",
    alpha = 0.8
  ) +
  facet_wrap("Variables") +
  theme_classic() +
  labs(
    title = "Proportion of Patients Achieving Program Goals",
    x = "Core Completion Status",
    y = "Proportion",
    fill = "Did They Meet Goal?"
  )


```

## Continuous variables

The effect of completing the core sessions on quantitative measures were examined using via an analysis of variance. The appropriate statistics from each test are found below.

```{r}

cont_vars <- list(
  "Post-core attendance" = 
    "Post-core attendance",
  "Overall attendance" = 
    "Overall attendance",
  "Maximum weight lost" = 
    "Maximum weight lost",
  "Percent weight lost" = 
    "Percent weight lost",
  "Met fat goal (percentage of sessions)" = 
    "Met fat goal (percentage of sessions)",
  "Met exercise goal (percentage of sessions)" = 
    "Met exercise goal (percentage of sessions)"
)

aov_readiness <- function(x, y){
  aov.results <- aov(
    df.processed[[x]] ~ df.processed[[y]],
    data = df.processed
      )
  
  return(aov.results)
}

aov_diet <- lapply(cont_vars, aov_readiness, y = "rtc_diet_groups")

# lapply(aov_diet, summary)

df.stats <- data.frame(
  "Variable"=character(),
  "F-statistic"=numeric(),
  "df"=integer(),
  "p-value"=integer(),
  row.names = NULL
)

for (i in names(aov_diet)){
  a <- summary(aov_diet[[i]])
  row.to.add <- data.frame(
    "Variable" = i,
    "F-statistic" = a[[1]]$`F value`[1],
    "df" = a[[1]]$`Df`[1],
    "p-value" = a[[1]]$`Pr(>F)`[1],
    row.names = NULL
    )
  df.stats <- rbind(df.stats, row.to.add)
}

knitr::kable(
  df.stats,
  output = "pandoc"
) %>% 
  kableExtra::kable_styling(
    bootstrap_options = c(
      "striped", 
      "hover", 
      "responsive"
      )
    )

df.processed %>% 
  tidyr::gather(
    key = Variables,
    value = Value,
    c(
      "Post-core attendance",
      "Overall attendance",
      "Maximum weight lost",
      "Percent weight lost",
      "Met fat goal (percentage of sessions)",
      "Met exercise goal (percentage of sessions)"
      )
  ) %>% 
  ggplot(
    aes(core_completion, Value)
  ) +
  geom_boxplot() +
  facet_wrap(
    "Variables",
    scales = "free"
    ) +
  theme_classic() +
  labs(
    title = "Continuous Outcomes for Completers v. Non-Completers",
    x = "Group",
    y = ""
  )

```








# Post-hoc Analysis

Readiness to change responses were used to create aggregate groups. Individuals self-classifying as 'Contemplative' or 'Preparation' were grouped together and individuals self-classifying as 'Action' or 'Maintain' were grouped together. The models were then recreated with the new groups.

```{r}
# df.processed <- df.processed %>% 
#   mutate(
#     rtc_diet_groups = ifelse(
#       rtc_diet == "preparation" | rtc_diet == "contemplative",
#       "preparation",
#         ifelse(
#           rtc_diet == "maintain" | rtc_diet == "action",
#           "action",
#           NA
#         )
#     ),
#     rtc_exercise_groups = ifelse(
#       rtc_exercise == "preparation" | rtc_exercise == "contemplative",
#       "preparation",
#         ifelse(
#           rtc_exercise == "maintain" | rtc_exercise == "action",
#           "action",
#           NA
#         )
#     ),
#   )

```

